<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tiny Chat — Single Room</title>
<style>
  * { box-sizing: border-box; }
  :root { --bg:#fff; --text:#000; --border:#000; --muted:#444; --maxw:860px; }
  html, body { height:100%; }
  body { margin:0; font:16px/1.5 "Times New Roman", Times, serif; background:var(--bg); color:var(--text); }
  header, footer { position:fixed; left:0; right:0; height:56px; display:flex; align-items:center; background:var(--bg); z-index:10; }
  header { top:0; border-bottom:1px solid var(--border); }
  footer { bottom:0; border-top:1px solid var(--border); }
  .wrap { width:100%; max-width:var(--maxw); margin:0 auto; padding:0 12px; }
  .head-row { display:flex; align-items:baseline; gap:12px; }
  .head-row h1 { font:bold 18px/1 "Times New Roman", Times, serif; margin:0; }
  #presence, #typing { font-size:13px; color:var(--muted); margin-top:4px; }
  main { margin-top:56px; margin-bottom:56px; height:calc(100vh - 112px); overflow:auto; border-left:1px solid var(--border); border-right:1px solid var(--border); }
  #log { padding:8px 12px 16px 12px; }
  #loadMore { display:none; margin:8px 0 12px 0; background:transparent; border:1px solid var(--border); padding:4px 8px; font-size:14px; cursor:pointer; }
  .msg { padding:6px 0; border-bottom:1px solid var(--border); word-wrap:break-word; overflow-wrap:anywhere; }
  .time { color:var(--muted); }
  .name { font-weight:bold; }
  .body { white-space:pre-wrap; }
  .composer { display:flex; gap:8px; align-items:center; }
  input[type="text"] { font:16px/1.4 "Times New Roman", Times, serif; border:1px solid var(--border); background:transparent; color:var(--text); padding:6px 8px; }
  #name { max-width:200px; }
  #body { flex:1; }
  #send { padding:6px 12px; border:1px solid var(--border); background:transparent; cursor:pointer; }
  small.help { display:block; margin-top:6px; color:var(--muted); font-size:13px; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="head-row">
      <h1>Tiny Chat</h1>
    </div>
    <div id="presence" aria-live="polite"></div>
    <div id="typing" aria-live="polite"></div>
  </div>
</header>

<main>
  <div id="log" class="wrap" aria-live="polite">
    <button id="loadMore">Load older messages</button>
  </div>
</main>

<footer>
  <div class="wrap">
    <form id="chat" class="composer" autocomplete="off">
      <input type="text" name="name" id="name" placeholder="Name" required />
      <input type="text" name="body" id="body" placeholder="Say something…" maxlength="1000" required />
      <button id="send" type="submit">Send</button>
    </form>
    <small class="help">Put your Supabase URL and anon key into <code>config.js</code>. Never expose service keys.</small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./config.js"></script>
<script>
  const SUPABASE_URL  = window.__TCFG?.SUPABASE_URL || "";
  const SUPABASE_ANON = window.__TCFG?.SUPABASE_ANON || "";
  if (!SUPABASE_URL || !SUPABASE_ANON) {
    alert("Missing Supabase config. Edit config.js and fill SUPABASE_URL and SUPABASE_ANON.");
  }
  const dom = (id)=>document.getElementById(id);
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function scrollToBottom(){ const frame = document.querySelector('main'); frame.scrollTop = frame.scrollHeight; }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  dom('name').value = localStorage.getItem('tinychat:name') || "";
  dom('name').addEventListener('input', e => localStorage.setItem('tinychat:name', e.target.value));

  let presenceChannel = null;
  let typingTimeout = null;
  let earliestLoaded = null;

  function renderPresence(state) {
    const names = Object.keys(state).sort();
    dom('presence').textContent = names.length ? `Present: ${names.join(', ')}` : 'Present: —';
  }

  function setupPresence(nameKey) {
    presenceChannel = supabase.channel('presence:main', { config: { presence: { key: nameKey } } });

    presenceChannel.on('presence', { event: 'sync' }, () => {
      renderPresence(presenceChannel.presenceState());
    });

    presenceChannel.on('broadcast', { event: 'typing' }, ({ payload }) => {
      dom('typing').textContent = `${payload.name} is typing…`;
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => dom('typing').textContent = "", 900);
    });

    presenceChannel.subscribe(async (status) => {
      if (status === 'SUBSCRIBED') {
        await presenceChannel.track({ name: nameKey, at: Date.now() });
      }
    });
  }

  function render(m, { prepend=false } = {}){
    const el = document.createElement('div');
    el.className = 'msg';
    const t = new Date(m.created_at).toLocaleTimeString();
    el.innerHTML = `<span class="time">[${t}]</span> <span class="name">${escapeHtml(m.user_name)}</span>: <span class="body">${escapeHtml(m.body)}</span>`;
    const log = dom('log');
    if (prepend) {
      const btn = dom('loadMore');
      if (btn && btn.nextSibling) log.insertBefore(el, btn.nextSibling);
      else log.appendChild(el);
    } else {
      log.appendChild(el);
    }
  }

  async function loadInitial() {
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);
    if (!error) {
      data.slice().reverse().forEach(m => render(m));
      if (data.length) {
        earliestLoaded = data[0].created_at;
        dom('loadMore').style.display = 'inline-block';
      }
      scrollToBottom();
    }
  }

  async function loadOlder() {
    if (!earliestLoaded) return;
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .lt('created_at', earliestLoaded)
      .order('created_at', { ascending: false })
      .limit(50);
    if (!error) {
      const arr = data.slice().reverse();
      arr.forEach(m => render(m, { prepend:true }));
      if (arr.length) earliestLoaded = arr[0].created_at;
      else dom('loadMore').disabled = true;
    }
  }

  supabase
    .channel('room:main')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' },
      payload => { render(payload.new); scrollToBottom(); })
    .subscribe();

  dom('chat').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = dom('name').value.trim();
    const body = dom('body').value.trim();
    if (!name || !body) return;
    if (window.__lastSend && Date.now() - window.__lastSend < 800) return;
    window.__lastSend = Date.now();

    const { error } = await supabase.from('messages').insert({ user_name: name, body });
    if (!error) {
      dom('body').value = '';
      dom('typing').textContent = "";
    }
  });

  dom('body').addEventListener('input', () => {
    const name = dom('name').value.trim() || 'guest';
    if (presenceChannel) {
      presenceChannel.send({ type: 'broadcast', event: 'typing', payload: { name } });
    }
  });

  (async () => {
    const nameKey = (localStorage.getItem('tinychat:name') || 'guest').slice(0, 32) || 'guest';
    setupPresence(nameKey);
    await loadInitial();
    dom('loadMore').addEventListener('click', loadOlder);
  })();
</script>
</body>
</html>
